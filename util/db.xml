<?xml version="1.0" ?>
<project name="AXRWebsite" basedir="." default="migrate">

	<!-- set the DSTAMP, TSTAMP and TODAY properties -->
	<tstamp/>

	<!-- load our configuration -->
	<property file="./db.properties" />

	<!-- this must be run before the first run -->
	<target name="first-run">
		<exec
			command="${progs.mysql} -h${db.host} -u${db.user} -p${db.pass} ${db.name} &lt; db/first-run.sql"
			checkreturn="true" />
	</target>

	<!-- create our migration task -->
	<target name="migrate">
		<!-- TODO create changesets table -->

		<!-- load the dbdeploy task -->
		<taskdef name="dbdeploy" classname="phing.tasks.ext.dbdeploy.DbDeployTask"/>

		<!-- these two filenames will contain the generated SQL to do the deploy and roll it back-->
		<property name="build.dbdeploy.deployfile" value="db/scripts/deploy-${DSTAMP}-${TSTAMP}.sql" />
		<property name="build.dbdeploy.undofile" value="db/scripts/undo-${DSTAMP}-${TSTAMP}.sql" />

		<!-- generate the deployment scripts -->
		<dbdeploy 
			url="mysql:host=${db.host};dbname=${db.name}" 
			userid="${db.user}" 
			password="${db.pass}" 
			dir="db/deltas" 
			outputfile="${build.dbdeploy.deployfile}" 
			undooutputfile="${build.dbdeploy.undofile}" />

		<!-- execute the SQL -->
		<exec
			command="${progs.mysql} -h${db.host} -u${db.user} -p${db.pass} ${db.name} &lt; ${build.dbdeploy.deployfile}"
			checkreturn="true" />
	</target>
</project>

